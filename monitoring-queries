---
# Default Monitoring Queries ConfigMap
# This ConfigMap contains custom SQL queries for PostgreSQL monitoring.
# These queries are used by the built-in Prometheus exporter.
#
# Reference: https://cloudnative-pg.io/documentation/current/monitoring/

apiVersion: v1
kind: ConfigMap
metadata:
  name: cnpg-default-monitoring-queries
  namespace: ${OPERATOR_NAMESPACE:-cnpg-system}
  labels:
    app.kubernetes.io/name: cloudnative-pg
    app.kubernetes.io/component: monitoring

data:
  queries: |
    # Database size metrics
    databases:
      query: |
        SELECT
          datname AS database,
          pg_database_size(datname) AS size_bytes
        FROM pg_database
        WHERE datname NOT IN ('template0', 'template1')
      metrics:
        - database:
            usage: "LABEL"
            description: "Database name"
        - size_bytes:
            usage: "GAUGE"
            description: "Database size in bytes"

    # Table bloat estimation
    table_bloat:
      query: |
        SELECT
          schemaname,
          tablename,
          pg_total_relation_size(schemaname||'.'||tablename) AS total_bytes,
          pg_relation_size(schemaname||'.'||tablename) AS table_bytes,
          pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename) AS index_bytes
        FROM pg_tables
        WHERE schemaname NOT IN ('pg_catalog', 'information_schema')
      metrics:
        - schemaname:
            usage: "LABEL"
            description: "Schema name"
        - tablename:
            usage: "LABEL"
            description: "Table name"
        - total_bytes:
            usage: "GAUGE"
            description: "Total table size including indexes"
        - table_bytes:
            usage: "GAUGE"
            description: "Table size without indexes"
        - index_bytes:
            usage: "GAUGE"
            description: "Total size of indexes"

    # Connection statistics
    connections:
      query: |
        SELECT
          datname AS database,
          count(*) FILTER (WHERE state = 'active') AS active,
          count(*) FILTER (WHERE state = 'idle') AS idle,
          count(*) FILTER (WHERE state = 'idle in transaction') AS idle_in_transaction,
          count(*) AS total
        FROM pg_stat_activity
        WHERE datname IS NOT NULL
        GROUP BY datname
      metrics:
        - database:
            usage: "LABEL"
            description: "Database name"
        - active:
            usage: "GAUGE"
            description: "Number of active connections"
        - idle:
            usage: "GAUGE"
            description: "Number of idle connections"
        - idle_in_transaction:
            usage: "GAUGE"
            description: "Number of idle in transaction connections"
        - total:
            usage: "GAUGE"
            description: "Total number of connections"

    # Replication lag
    replication_lag:
      query: |
        SELECT
          application_name,
          client_addr,
          state,
          EXTRACT(EPOCH FROM (NOW() - pg_last_xact_replay_timestamp())) AS lag_seconds
        FROM pg_stat_replication
      metrics:
        - application_name:
            usage: "LABEL"
            description: "Application name"
        - client_addr:
            usage: "LABEL"
            description: "Client address"
        - state:
            usage: "LABEL"
            description: "Replication state"
        - lag_seconds:
            usage: "GAUGE"
            description: "Replication lag in seconds"

    # Transaction statistics
    transactions:
      query: |
        SELECT
          datname AS database,
          xact_commit AS commits,
          xact_rollback AS rollbacks,
          blks_read AS blocks_read,
          blks_hit AS blocks_hit,
          tup_returned AS tuples_returned,
          tup_fetched AS tuples_fetched,
          tup_inserted AS tuples_inserted,
          tup_updated AS tuples_updated,
          tup_deleted AS tuples_deleted
        FROM pg_stat_database
        WHERE datname NOT IN ('template0', 'template1')
      metrics:
        - database:
            usage: "LABEL"
            description: "Database name"
        - commits:
            usage: "COUNTER"
            description: "Number of committed transactions"
        - rollbacks:
            usage: "COUNTER"
            description: "Number of rolled back transactions"
        - blocks_read:
            usage: "COUNTER"
            description: "Number of disk blocks read"
        - blocks_hit:
            usage: "COUNTER"
            description: "Number of buffer hits"
        - tuples_returned:
            usage: "COUNTER"
            description: "Number of rows returned by queries"
        - tuples_fetched:
            usage: "COUNTER"
            description: "Number of rows fetched by queries"
        - tuples_inserted:
            usage: "COUNTER"
            description: "Number of rows inserted"
        - tuples_updated:
            usage: "COUNTER"
            description: "Number of rows updated"
        - tuples_deleted:
            usage: "COUNTER"
            description: "Number of rows deleted"

    # Lock statistics
    locks:
      query: |
        SELECT
          pg_database.datname AS database,
          mode,
          count(*) AS locks
        FROM pg_locks
        JOIN pg_database ON pg_locks.database = pg_database.oid
        WHERE pg_database.datname NOT IN ('template0', 'template1')
        GROUP BY pg_database.datname, mode
      metrics:
        - database:
            usage: "LABEL"
            description: "Database name"
        - mode:
            usage: "LABEL"
            description: "Lock mode"
        - locks:
            usage: "GAUGE"
            description: "Number of locks"
